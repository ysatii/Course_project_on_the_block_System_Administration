---
- name: Restore PostgreSQL database with extensions cleanup
  hosts: zabbix_server
  become: yes
  tasks:
    - name: Drop extension uuid-ossp if exists
      postgresql_ext:
        name: "uuid-ossp"
        state: absent
        db: zabbix
        login_user: zabbix
        login_host: c-c9q874mm11tmmfbo3kqf.rw.mdb.yandexcloud.net
        login_port: 6432
        login_password: "12345678"
      ignore_errors: yes

    - name: Drop extension xml2 if exists
      postgresql_ext:
        name: "xml2"
        state: absent
        db: zabbix
        login_user: zabbix
        login_host: c-c9q874mm11tmmfbo3kqf.rw.mdb.yandexcloud.net
        login_port: 6432
        login_password: "12345678"
      ignore_errors: yes

    - name: Run pg_restore to restore the database
      command: >
        pg_restore -h c-c9q874mm11tmmfbo3kqf.rw.mdb.yandexcloud.net
                   -p 6432
                   -U zabbix
                   -d zabbix
                   -v /tmp/zabbix.backup
                   --clean
      environment:
        PGPASSWORD: "12345678"
      register: restore_output
      ignore_errors: yes

    - name: Debug output
      debug:
        var: restore_output.stdout_lines
